<template>
  <div class="image-diagnosis-page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
      <div class="header-left">
        <div class="logo">ğŸ¥</div>
        <div class="header-title">åŒ»å­¦å½±åƒè¯Šæ–­ç³»ç»Ÿ</div>
      </div>
      <div class="header-right">
        <div class="header-icon">âš™ï¸</div>
        <div class="user-info">
          <span class="user-name">å¼ åŒ»ç”Ÿ</span>
          <span>â–¼</span>
        </div>
      </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="page-header">
        <h1 class="page-title">æ–°å»ºå½±åƒæ£€æŸ¥</h1>
        <p class="page-subtitle">ä¸Šä¼ æ‚£è€…å½±åƒå¹¶å¡«å†™æ£€æŸ¥ä¿¡æ¯ï¼Œå¼€å§‹è¯Šæ–­æµç¨‹</p>
      </div>

      <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
      <div class="steps">
        <div class="step" :class="{ active: currentStep >= 1 }">
          <div class="step-number">1</div>
          <div class="step-label">å¡«å†™ç—…ä¾‹ä¿¡æ¯</div>
        </div>
        <div class="step" :class="{ active: currentStep >= 2 }">
          <div class="step-number">2</div>
          <div class="step-label">å½±åƒä¸Šä¼ </div>
        </div>
        <div class="step" :class="{ active: currentStep >= 3 }">
          <div class="step-number">3</div>
          <div class="step-label">AIè¯Šæ–­</div>
        </div>
        <div class="step" :class="{ active: currentStep >= 4 }">
          <div class="step-number">4</div>
          <div class="step-label">ç¡®è®¤è¯Šæ–­</div>
        </div>
      </div>

      <!-- æ­¥éª¤1: æ‚£è€…åŸºæœ¬ä¿¡æ¯ -->
      <div v-if="currentStep === 1" class="form-card">
        <div class="form-section-title">æ‚£è€…åŸºæœ¬ä¿¡æ¯</div>
        <div class="form-section-subtitle">è¯·å¡«å†™æ‚£è€…çš„åŸºæœ¬ä¿¡æ¯ï¼Œå…¶ä¸­*ä¸ºå¿…å¡«é¡¹</div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç—…ä¾‹ç¼–å· <span class="required">*</span></label>
            <input 
              type="text" 
              class="form-input" 
              placeholder="è‡ªåŠ¨ç”Ÿæˆ" 
              v-model="formData.caseNumber"
            >
          </div>
          <div class="form-group">
            <label class="form-label">æ‚£è€…å§“å <span class="required">*</span></label>
            <input 
              type="text" 
              class="form-input" 
              placeholder="è¯·è¾“å…¥æ‚£è€…å§“å"
              v-model="formData.patientName"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ€§åˆ« <span class="required">*</span></label>
            <select class="form-select" v-model="formData.gender">
              <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
              <option value="ç”·">ç”·</option>
              <option value="å¥³">å¥³</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">å¹´é¾„ <span class="required">*</span></label>
            <input 
              type="number" 
              class="form-input" 
              placeholder="è¯·è¾“å…¥æ‚£è€…å¹´é¾„"
              v-model="formData.age"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç”³è¯·ç§‘å®¤ <span class="required">*</span></label>
            <select class="form-select" v-model="formData.department">
              <option value="">è¯·é€‰æ‹©ç§‘å®¤</option>
              <option value="éª¨ç§‘">éª¨ç§‘</option>
              <option value="è„ŠæŸ±å¤–ç§‘">è„ŠæŸ±å¤–ç§‘</option>
              <option value="åˆ›ä¼¤éª¨ç§‘">åˆ›ä¼¤éª¨ç§‘</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ç”³è¯·åŒ»ç”Ÿ <span class="required">*</span></label>
            <input 
              type="text" 
              class="form-input" 
              placeholder="å½“å‰ç”¨æˆ·"
              v-model="formData.doctor"
            >
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤2: æ£€æŸ¥ä¿¡æ¯å’Œå½±åƒä¸Šä¼  -->
      <div v-if="currentStep === 2">
        <!-- æ£€æŸ¥ä¿¡æ¯ -->
        <div class="form-card">
          <div class="form-section-title">æ£€æŸ¥ä¿¡æ¯</div>
          <div class="form-section-subtitle">è¯·é€‰æ‹©æ£€æŸ¥ç›¸å…³ä¿¡æ¯ï¼Œä»¥ä¾¿å‡†ç¡®åˆ†æå’Œè¯Šæ–­</div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ£€æŸ¥ç±»å‹ <span class="required">*</span></label>
              <select class="form-select" v-model="formData.examType">
                <option value="">è¯·é€‰æ‹©æ£€æŸ¥ç±»å‹</option>
                <option value="Xå…‰">Xå…‰</option>
                <option value="CT">CT</option>
                <option value="MRI">MRI</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ£€æŸ¥éƒ¨ä½ <span class="required">*</span></label>
              <select class="form-select" v-model="formData.examPart">
                <option value="">è¯·é€‰æ‹©æ£€æŸ¥éƒ¨ä½</option>
                <option value="è„ŠæŸ±">è„ŠæŸ±</option>
                <option value="éª¨ç›†">éª¨ç›†</option>
                <option value="å››è‚¢">å››è‚¢</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ£€æŸ¥è®¾å¤‡</label>
              <select class="form-select" v-model="formData.equipment">
                <option value="">è¯·é€‰æ‹©æ£€æŸ¥è®¾å¤‡</option>
                <option value="è®¾å¤‡1">è®¾å¤‡1</option>
                <option value="è®¾å¤‡2">è®¾å¤‡2</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ£€æŸ¥æ—¥æœŸ <span class="required">*</span></label>
              <input 
                type="date" 
                class="form-input" 
                placeholder="è¯·é€‰æ‹©æ£€æŸ¥æ—¥æœŸ"
                v-model="formData.examDate"
              >
            </div>
          </div>
        </div>

        <!-- å½±åƒä¸Šä¼  -->
        <div class="form-card">
          <div class="form-section-title">å½±åƒä¸Šä¼ </div>
          <div class="form-section-subtitle">æ”¯æŒDICOMã€JPGã€PNGæ ¼å¼æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡200MBï¼Œæœ€å¤šå¯ä¸Šä¼ 50ä¸ªæ–‡ä»¶</div>

          <div class="upload-section">
            <div 
              class="upload-area" 
              :class="{ dragover: isDragOver }"
              @dragover.prevent="handleDragOver"
              @dragleave="handleDragLeave"
              @drop.prevent="handleDrop"
              @click="triggerFileInput"
            >
              <div class="upload-icon">â˜ï¸</div>
              <div class="upload-title">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤æˆ–ç‚¹å‡»ä¸Šä¼ </div>
              <div class="upload-subtitle">æ”¯æŒDICOMã€JPGã€PNGæ ¼å¼</div>
              <div class="upload-hint">å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡200MBï¼Œæœ€å¤šå¯ä¸Šä¼ 50ä¸ªæ–‡ä»¶</div>
              <button class="upload-btn" @click.stop="triggerFileInput">å¼€å§‹ä¸Šä¼ </button>
            </div>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div v-if="uploadedFiles.length > 0" class="file-list">
              <h4>å·²ä¸Šä¼ æ–‡ä»¶ï¼š</h4>
              <div v-for="(file, index) in uploadedFiles" :key="index" class="file-item">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
                <button class="remove-btn" @click="removeFile(index)">åˆ é™¤</button>
              </div>
            </div>
          </div>

          <div class="help-section">
            <div class="help-title">ğŸ“‹ ä¸Šä¼ å¸®åŠ©</div>
            <ul class="help-list">
              <li>DICOMæ–‡ä»¶è¯´æ˜ï¼šæ”¯æŒæ ‡å‡†DICOM 3.0æ ¼å¼çš„åŒ»å­¦å½±åƒæ–‡ä»¶ä¸Šä¼ </li>
              <li>æ‰¹é‡ä¸Šä¼ ï¼šæ”¯æŒä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†</li>
              <li>éšç§ä¿æŠ¤ï¼šä¸Šä¼ çš„æ‰€æœ‰åŒ»å­¦å½±åƒæ•°æ®å‡é‡‡ç”¨åŒ»ç–—çº§åŠ å¯†ä¿æŠ¤</li>
            </ul>
          </div>
        </div>

        <!-- ä¸´åºŠç—‡çŠ¶ä¸ç—…å² -->
        <div class="form-card">
          <div class="form-section-title">ä¸´åºŠç—‡çŠ¶ä¸ç—…å²</div>
          <div class="form-group">
            <textarea 
              class="form-textarea" 
              placeholder="è¯·è¾“å…¥æ‚£è€…çš„ä¸´åºŠç—‡çŠ¶ã€ç—…å²ä¿¡æ¯ã€æ—¢å¾€è¯Šæ–­ï¼ˆé€‰å¡«ï¼‰"
              v-model="formData.symptoms"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤3: AIè¯Šæ–­åˆ†æ -->
      <div v-if="currentStep === 3" class="form-card">
        <div class="form-section-title">AIè¯Šæ–­åˆ†æ</div>
        <div class="form-section-subtitle">åŸºäºYOLOç®—æ³•çš„æ™ºèƒ½è¯Šæ–­ç»“æœ</div>

        <!-- è¯Šæ–­è¿›åº¦ -->
        <div v-if="isAnalyzing" class="analysis-progress">
          <div class="progress-bar">
            <div class="progress-fill" :style="{ width: analysisProgress + '%' }"></div>
          </div>
          <p class="progress-text">AIæ­£åœ¨åˆ†æå½±åƒæ•°æ®... {{ analysisProgress }}%</p>
        </div>

        <!-- è¯Šæ–­ç»“æœ -->
        <div v-if="diagnosisResult" class="diagnosis-result">
          <div class="result-summary">
            <h3>AIè¯Šæ–­å®Œæˆ</h3>
            <div class="confidence-score">
              åˆ†ææ—¶é—´: {{ new Date().toLocaleString() }}
            </div>
          </div>

          <div class="findings">
            <h4>ä¸»è¦è¯Šæ–­ç»“æœï¼š</h4>
            <div v-for="(finding, index) in diagnosisResult.findings" :key="index" class="finding-item">
              <div class="finding-name">{{ finding.name }}</div>
              <div class="finding-confidence">ç½®ä¿¡åº¦: {{ (finding.confidence * 100).toFixed(1) }}%</div>
              <div class="finding-description">{{ finding.description }}</div>
            </div>
          </div>

          <div class="recommendations">
            <h4>AIå»ºè®®ï¼š</h4>
            <ul>
              <li v-for="(rec, index) in diagnosisResult.recommendations" :key="index">{{ rec }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤4: ç¡®è®¤è¯Šæ–­ -->
      <div v-if="currentStep === 4" class="diagnosis-confirmation">
        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="top-bar">
          <div class="top-bar-left">å½±åƒè¯Šæ–­ä¸­å¿ƒ</div>
          <div class="top-bar-center">
            <span>ç—…ä¾‹ç¼–å·ï¼š{{ formData.caseNumber }}</span>
            <span>æ‚£è€…ï¼š{{ formData.patientName }}ï¼ˆ{{ formData.gender }}ï¼Œ{{ formData.age }}å²ï¼‰</span>
            <span>éƒ¨ä½ï¼š{{ formData.examPart }}</span>
          </div>
          <div class="top-bar-right">
            <button class="btn btn-save" @click="handleSave">ä¿å­˜</button>
            <button class="btn btn-ai" @click="handleAIAnalysis">é‡æ–°åˆ†æ</button>
            <button class="btn btn-report" @click="handleGenerateReport">ç”ŸæˆæŠ¥å‘Š</button>
          </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div class="main-container">
          <!-- å·¦ä¾§å·¥å…·æ  -->
          <div class="left-toolbar">
            <div class="toolbar-section">
              <div class="toolbar-title">å½±åƒè¯Šæ–­ä¸­å¿ƒ</div>
            </div>
            
            <div class="toolbar-section">
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'pan' }" 
                @click="setActiveTool('pan')"
                title="å¹³ç§»"
              >
                âŠ™
              </div>
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'measure' }" 
                @click="setActiveTool('measure')"
                title="æµ‹é‡"
              >
                â¬š
              </div>
            </div>
            
            <div class="toolbar-section">
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'rectangle' }" 
                @click="setActiveTool('rectangle')"
                title="çŸ©å½¢æ ‡æ³¨"
              >
                â¬œ
              </div>
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'circle' }" 
                @click="setActiveTool('circle')"
                title="åœ†å½¢æ ‡æ³¨"
              >
                â—‹
              </div>
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'freehand' }" 
                @click="setActiveTool('freehand')"
                title="è‡ªç”±ç»˜åˆ¶"
              >
                âœ
              </div>
              <div class="toolbar-item" 
                :class="{ active: activeTool === 'text' }" 
                @click="setActiveTool('text')"
                title="æ–‡å­—æ ‡æ³¨"
              >
                T
              </div>
            </div>
            
            <div class="toolbar-section">
              <div class="toolbar-item" 
                @click="undoLastAnnotation"
                title="æ’¤é”€"
              >
                â†¶
              </div>
              <div class="toolbar-item" 
                @click="clearAnnotations"
                title="æ¸…é™¤æ‰€æœ‰"
              >
                ğŸ—‘
              </div>
            </div>
            
            <div class="toolbar-section">
              <div class="color-picker">
                <input 
                  type="color" 
                  v-model="currentColor" 
                  title="é€‰æ‹©é¢œè‰²"
                  class="color-input"
                >
              </div>
            </div>
          </div>

          <!-- ä¸­é—´å½±åƒåŒºåŸŸ -->
          <div class="middle-section">
            <!-- å½±åƒæ§åˆ¶æ  -->
            <div class="image-controls">
              <div class="series-info">å½±åƒåºåˆ—ï¼š{{ currentImage ? currentImage.name : 'N/A' }} ({{ currentImageIndex + 1 }}/{{ uploadedFiles.length }})</div>
              <div class="nav-buttons">
                <button class="nav-btn" @click="previousImage" :disabled="currentImageIndex === 0">â†</button>
                <button class="nav-btn" @click="nextImage" :disabled="currentImageIndex === uploadedFiles.length - 1">â†’</button>
              </div>
              <div class="image-input">
                <input 
                  type="text" 
                  placeholder="çª—ä½:" 
                  v-model="windowLevel"
                  @change="updateWindowLevel"
                >
                <input 
                  type="text" 
                  placeholder="çª—å®½:" 
                  v-model="windowWidth"
                  @change="updateWindowWidth"
                >
              </div>
              <div style="display: flex; gap: 10px; margin-left: 20px;">
                <button class="zoom-btn" @click="setPresetWindow('soft')">è½¯ç»„ç»‡</button>
                <button class="zoom-btn" @click="setPresetWindow('bone')">éª¨çª—</button>
              </div>
              <div class="zoom-controls">
                <button class="zoom-btn" @click="zoomOut">ğŸ”</button>
                <button class="zoom-btn" @click="resetZoom">100%</button>
                <button class="zoom-btn" @click="zoomIn">ğŸ”</button>
                <button class="zoom-btn" @click="fitToWindow">â›¶</button>
              </div>
            </div>

            <!-- å½±åƒæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="image-viewer" ref="imageViewer">
              <div class="image-container" ref="imageContainer">
                <img 
                  v-if="currentImage"
                  :src="currentImage.url" 
                  :alt="currentImage.name" 
                  class="medical-image"
                  :style="imageStyle"
                  @load="onImageLoad"
                  @wheel="onWheel"
                >
                <div v-else class="no-image-placeholder">
                  <p>æš‚æ— å½±åƒå¯æ˜¾ç¤º</p>
                </div>
                
                <!-- AIæ ‡æ³¨ -->
                <div 
                  v-for="(annotation, index) in aiAnnotations" 
                  :key="index"
                  class="annotation" 
                  :class="annotation.type"
                  :style="annotation.style"
                >
                  <div class="annotation-label">{{ annotation.label }}</div>
                </div>

                <!-- Canvasç»˜åˆ¶å±‚ -->
                <canvas 
                  ref="annotationCanvas"
                  class="annotation-canvas"
                  :style="{ cursor: getCursorStyle() }"
                ></canvas>
              </div>
            </div>

            <!-- ç¼©ç•¥å›¾å¯¼èˆª -->
            <div class="thumbnail-nav" v-if="uploadedFiles.length > 0">
              <div 
                v-for="(file, index) in uploadedFiles" 
                :key="index"
                class="thumbnail" 
                :class="{ active: index === currentImageIndex }"
                @click="selectImage(index)"
              >
                <img v-if="file.url" :src="file.url" :alt="file.name" class="thumbnail-image">
                <span class="thumbnail-number">{{ index + 1 }}</span>
              </div>
            </div>
          </div>

          <!-- å³ä¾§è¯Šæ–­ç»“æœé¢æ¿ -->
          <div class="right-panel">
            <div class="panel-tabs">
              <div 
                class="panel-tab" 
                :class="{ active: activeTab === 'diagnosis' }"
                @click="setActiveTab('diagnosis')"
              >
                AIè¯Šæ–­ç»“æœ
              </div>
              <div 
                class="panel-tab" 
                :class="{ active: activeTab === 'review' }"
                @click="setActiveTab('review')"
              >
                åŒ»ç”Ÿå®¡æ ¸
              </div>
              <div 
                class="panel-tab" 
                :class="{ active: activeTab === 'patient' }"
                @click="setActiveTab('patient')"
              >
                æ‚£è€…ä¿¡æ¯
              </div>
            </div>

            <div class="panel-content">
              <!-- AIè¯Šæ–­ç»“æœ -->
              <div v-if="activeTab === 'diagnosis'">
                <div class="section-title">ä¸»è¦è¯Šæ–­ç»“æœ</div>

                <div 
                  v-for="(result, index) in diagnosisResults" 
                  :key="index"
                  class="result-item"
                >
                  <div class="result-title">
                    <div class="result-name">{{ result.name }}</div>
                    <div class="result-confidence">{{ (result.confidence * 100).toFixed(0) }}%ç½®ä¿¡åº¦</div>
                  </div>
                  <div class="result-description">{{ result.description }}</div>
                </div>

                <div class="section-title">æ¬¡è¦å‘ç°</div>
                <div 
                  v-for="(finding, index) in minorFindings" 
                  :key="index"
                  class="finding-item"
                >
                  {{ finding }}
                </div>

                <div class="ai-info">
                  <div class="ai-info-title">AIå»ºè®®</div>
                  <div 
                    v-for="(suggestion, index) in aiSuggestions" 
                    :key="index"
                    class="ai-info-item"
                  >
                    {{ index + 1 }}. {{ suggestion }}
                  </div>
                </div>
              </div>

              <!-- åŒ»ç”Ÿå®¡æ ¸ -->
              <div v-if="activeTab === 'review'">
                <div class="section-title">åŒ»ç”Ÿå®¡æ ¸æ„è§</div>
                
                <div class="review-section">
                  <h4>AIè¯Šæ–­è¯„ä¼°</h4>
                  <div class="review-item">
                    <label>è¯Šæ–­å‡†ç¡®æ€§ï¼š</label>
                    <select v-model="doctorReview.accuracy">
                      <option value="accurate">å‡†ç¡®</option>
                      <option value="mostly-accurate">åŸºæœ¬å‡†ç¡®</option>
                      <option value="partially-accurate">éƒ¨åˆ†å‡†ç¡®</option>
                      <option value="inaccurate">ä¸å‡†ç¡®</option>
                    </select>
                  </div>
                  
                  <div class="review-item">
                    <label>ç½®ä¿¡åº¦è¯„ä¼°ï¼š</label>
                    <select v-model="doctorReview.confidence">
                      <option value="high">é«˜</option>
                      <option value="medium">ä¸­ç­‰</option>
                      <option value="low">ä½</option>
                    </select>
                  </div>
                </div>

                <div class="review-section">
                  <h4>åŒ»ç”Ÿæ„è§</h4>
                  <textarea 
                    v-model="doctorReview.comments"
                    placeholder="è¯·è¾“å…¥æ‚¨çš„è¯Šæ–­æ„è§å’Œä¿®æ”¹å»ºè®®..."
                    class="review-textarea"
                  ></textarea>
                </div>

                <div class="review-section">
                  <h4>æœ€ç»ˆè¯Šæ–­</h4>
                  <div class="final-diagnosis">
                    <div v-for="(result, index) in finalDiagnosis" :key="index" class="diagnosis-item">
                      <input v-model="result.name" placeholder="è¯Šæ–­åç§°" class="diagnosis-input">
                      <input v-model="result.confidence" placeholder="ç½®ä¿¡åº¦" class="confidence-input">
                      <textarea v-model="result.description" placeholder="è¯Šæ–­æè¿°" class="description-textarea"></textarea>
                      <button @click="removeDiagnosis(index)" class="remove-btn">åˆ é™¤</button>
                    </div>
                    <button @click="addDiagnosis" class="add-btn">æ·»åŠ è¯Šæ–­</button>
                  </div>
                </div>

                <div class="review-section">
                  <h4>æ²»ç–—å»ºè®®</h4>
                  <textarea 
                    v-model="doctorReview.treatment"
                    placeholder="è¯·è¾“å…¥æ²»ç–—å»ºè®®..."
                    class="review-textarea"
                  ></textarea>
                </div>
              </div>

              <!-- æ‚£è€…ä¿¡æ¯ -->
              <div v-if="activeTab === 'patient'">
                <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                <div class="patient-info">
                  <div class="info-item">
                    <span class="label">å§“åï¼š</span>
                    <span class="value">{{ formData.patientName }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">æ€§åˆ«ï¼š</span>
                    <span class="value">{{ formData.gender }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">å¹´é¾„ï¼š</span>
                    <span class="value">{{ formData.age }}å²</span>
                  </div>
                  <div class="info-item">
                    <span class="label">ç§‘å®¤ï¼š</span>
                    <span class="value">{{ formData.department }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">åŒ»ç”Ÿï¼š</span>
                    <span class="value">{{ formData.doctor }}</span>
                  </div>
                </div>

                <div class="section-title">æ£€æŸ¥ä¿¡æ¯</div>
                <div class="exam-info">
                  <div class="info-item">
                    <span class="label">æ£€æŸ¥ç±»å‹ï¼š</span>
                    <span class="value">{{ formData.examType }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">æ£€æŸ¥éƒ¨ä½ï¼š</span>
                    <span class="value">{{ formData.examPart }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">æ£€æŸ¥æ—¥æœŸï¼š</span>
                    <span class="value">{{ formData.examDate }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">è®¾å¤‡ï¼š</span>
                    <span class="value">{{ formData.equipment }}</span>
                  </div>
                </div>

                <div class="section-title">ä¸´åºŠç—‡çŠ¶</div>
                <div class="symptoms-info">
                  {{ formData.symptoms || 'æš‚æ— ä¸´åºŠç—‡çŠ¶æè¿°' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æŒ‰é’®ç»„ -->
      <div class="form-actions">
        <button class="btn btn-cancel" @click="handleCancel">å–æ¶ˆ</button>
        <button 
          v-if="currentStep < 3" 
          class="btn btn-next" 
          @click="handleNext"
          :disabled="!canProceed"
        >
          ä¸‹ä¸€æ­¥
        </button>
        
        <!-- æç¤ºä¿¡æ¯ -->
        <div v-if="!canProceed" class="validation-hint">
          <p>è¯·å®Œæˆä»¥ä¸‹å¿…å¡«é¡¹ï¼š</p>
          <ul>
            <li v-if="currentStep === 1">
              <span v-if="!formData.caseNumber">â€¢ ç—…ä¾‹ç¼–å·</span>
              <span v-if="!formData.patientName">â€¢ æ‚£è€…å§“å</span>
              <span v-if="!formData.gender">â€¢ æ€§åˆ«</span>
              <span v-if="!formData.age">â€¢ å¹´é¾„</span>
              <span v-if="!formData.department">â€¢ ç”³è¯·ç§‘å®¤</span>
            </li>
            <li v-if="currentStep === 2">
              <span v-if="!formData.examType">â€¢ æ£€æŸ¥ç±»å‹</span>
              <span v-if="!formData.examPart">â€¢ æ£€æŸ¥éƒ¨ä½</span>
              <span v-if="!formData.examDate">â€¢ æ£€æŸ¥æ—¥æœŸ</span>
              <span v-if="uploadedFiles.length === 0">â€¢ å½±åƒæ–‡ä»¶</span>
            </li>
          </ul>
        </div>
        <button 
          v-if="currentStep === 3 && !diagnosisResult" 
          class="btn btn-start" 
          @click="startAIDiagnosis"
          :disabled="uploadedFiles.length === 0"
        >
          å¼€å§‹AIè¯Šæ–­
        </button>
        <button 
          v-if="currentStep === 3 && diagnosisResult" 
          class="btn btn-next" 
          @click="handleNext"
        >
          è¿›å…¥ç¡®è®¤è¯Šæ–­
        </button>
        <button 
          v-if="currentStep === 4" 
          class="btn btn-finish" 
          @click="handleFinish"
        >
          å®Œæˆè¯Šæ–­
        </button>
      </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input 
      ref="fileInput" 
      type="file" 
      multiple 
      accept=".dcm,.jpg,.jpeg,.png" 
      style="display: none"
      @change="handleFileSelect"
    >
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'

const router = useRouter()

// å½“å‰æ­¥éª¤
const currentStep = ref(1)

// è¡¨å•æ•°æ®
const formData = reactive({
  caseNumber: '',
  patientName: '',
  gender: '',
  age: '',
  department: '',
  doctor: 'å¼ åŒ»ç”Ÿ',
  examType: '',
  examPart: '',
  equipment: '',
  examDate: '',
  symptoms: ''
})

// æ–‡ä»¶ä¸Šä¼ ç›¸å…³
const uploadedFiles = ref<File[]>([])
const isDragOver = ref(false)
const fileInput = ref<HTMLInputElement>()

// è¯Šæ–­ç›¸å…³
const isAnalyzing = ref(false)
const analysisProgress = ref(0)
const diagnosisResult = ref<any>(null)

// ç¬¬å››æ­¥ç¡®è®¤è¯Šæ–­ç›¸å…³æ•°æ®
const activeTool = ref('pan')
const activeTab = ref('diagnosis')
const currentImageIndex = ref(0)
const windowLevel = ref(40)
const windowWidth = ref(400)
const zoomLevel = ref(1)
const panX = ref(0)
const panY = ref(0)

// Canvasç›¸å…³
const imageViewer = ref<HTMLElement>()
const imageContainer = ref<HTMLElement>()
const annotationCanvas = ref<HTMLCanvasElement>()

// ç»˜åˆ¶ç›¸å…³
let canvas: HTMLCanvasElement | null = null
let ctx: CanvasRenderingContext2D | null = null
let isDrawing = false
let startX = 0
let startY = 0
let currentPath: any[] = []

// AIå¤„ç†åçš„å›¾åƒæ•°æ®ï¼ˆåŒ…å«æ ‡æ³¨ï¼‰
const aiProcessedImages = ref<any[]>([])

// AIæ ‡æ³¨æ•°æ®
const aiAnnotations = ref([
  {
    type: 'red',
    label: 'æ¤é—´ç›˜çªå‡º',
    style: { width: '120px', height: '100px', left: '35%', top: '25%' }
  },
  {
    type: 'yellow',
    label: 'æ¤ä½“éª¨è´¨å¢ç”Ÿ',
    style: { width: '100px', height: '80px', left: '45%', top: '45%' }
  }
])

// è¯Šæ–­ç»“æœæ•°æ®
const diagnosisResults = ref([
  {
    name: 'è…°æ¤é—´ç›˜çªå‡º (L4-L5)',
    confidence: 0.94,
    description: 'L4-L5æ¤é—´ç›˜åæ–¹çªå‡ºçº¦9.5mmï¼Œå‹è¿«ç¡¬è†œå›Šï¼Œç›¸åº”æ°´å¹³ç®¡æœ‰æ•ˆå®½åº¦å˜çª„ã€‚'
  },
  {
    name: 'æ¤ä½“éª¨è´¨å¢ç”Ÿ (L3-L5)',
    confidence: 0.87,
    description: 'L3-L5æ¤ä½“è¾¹ç¼˜è§éª¨è´¨å¢ç”Ÿï¼Œç¬¦åˆé€€è¡Œæ€§æ”¹å˜ï¼Œå¾…åˆå¹¶å…¶ä»–å½±åƒå­¦è¡¨ç°ã€‚'
  },
  {
    name: 'æ¤ç®¡ç‹­çª„ (L5-S1)',
    confidence: 0.82,
    description: 'L5-S1æ°´å¹³æ¤ç®¡æœ‰æ•ˆå®½åº¦çº¦9mmï¼Œæç¤ºæ¤ç®¡ç‹­çª„ã€‚'
  }
])

const minorFindings = ref([
  'L2-L3æ¤é—´ç›˜è½»åº¦è†¨å‡º',
  'è…°æ¤ç”Ÿç†æ›²åº¦å˜ç›´',
  'æ¤ä½“è½¯éª¨ç»ˆæ¿ä¸è§„åˆ™å¼‚å¸¸'
])

const aiSuggestions = ref([
  'ç»“åˆæ‚£è€…ä¸´åºŠç—‡çŠ¶ï¼Œå¿…è¦æ—¶è¿›ä¸€æ­¥è¡ŒCTæˆ–å¢å¼ºMRIæ£€æŸ¥',
  'æ‚£è€…å¹´é¾„åŠå½±åƒå­¦è¡¨ç°ï¼Œå»ºè®®éª¨ç§‘ä¸´åºŠåŒ»ç”Ÿè¯„ä¼°æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ²»ç–—',
  'å»ºè®®å®šæœŸå¤æŸ¥ï¼Œç›‘æµ‹ç—…æƒ…å˜åŒ–'
])

// åŒ»ç”Ÿå®¡æ ¸æ•°æ®
const doctorReview = reactive({
  accuracy: 'accurate',
  confidence: 'high',
  comments: '',
  treatment: ''
})

const finalDiagnosis = ref([
  {
    name: 'è…°æ¤é—´ç›˜çªå‡º (L4-L5)',
    confidence: '94%',
    description: 'L4-L5æ¤é—´ç›˜åæ–¹çªå‡ºçº¦9.5mmï¼Œå‹è¿«ç¡¬è†œå›Šï¼Œç›¸åº”æ°´å¹³ç®¡æœ‰æ•ˆå®½åº¦å˜çª„ã€‚'
  }
])

// æ ‡æ³¨ç›¸å…³æ•°æ®
const annotations = ref<any[]>([])
const currentColor = ref('#ff0000')
const currentLineWidth = ref(2)
const isPanning = ref(false)

// è®¡ç®—å±æ€§
const canProceed = computed(() => {
  if (currentStep.value === 1) {
    return formData.caseNumber && formData.patientName && formData.gender && formData.age && formData.department
  }
  if (currentStep.value === 2) {
    return formData.examType && formData.examPart && formData.examDate && uploadedFiles.value.length > 0
  }
  return true
})

// åˆå§‹åŒ–
onMounted(() => {
  // ç”Ÿæˆç—…ä¾‹ç¼–å·
  formData.caseNumber = generateCaseNumber()
})

// ç”Ÿæˆç—…ä¾‹ç¼–å·
const generateCaseNumber = () => {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0')
  return `CASE${year}${month}${day}${random}`
}

// æ–‡ä»¶æ‹–æ‹½å¤„ç†
const handleDragOver = (e: DragEvent) => {
  e.preventDefault()
  isDragOver.value = true
}

const handleDragLeave = () => {
  isDragOver.value = false
}

const handleDrop = (e: DragEvent) => {
  e.preventDefault()
  isDragOver.value = false
  
  const files = Array.from(e.dataTransfer?.files || [])
  processFiles(files)
}

// è§¦å‘æ–‡ä»¶é€‰æ‹©
const triggerFileInput = () => {
  fileInput.value?.click()
}

// æ–‡ä»¶é€‰æ‹©å¤„ç†
const handleFileSelect = (e: Event) => {
  const target = e.target as HTMLInputElement
  const files = Array.from(target.files || [])
  processFiles(files)
}

// å¤„ç†æ–‡ä»¶
const processFiles = (files: File[]) => {
  const validFiles = files.filter(file => {
    const validTypes = ['.dcm', '.jpg', '.jpeg', '.png']
    const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase()
    
    if (!validTypes.includes(fileExtension)) {
      ElMessage.error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`)
      return false
    }
    
    if (file.size > 200 * 1024 * 1024) {
      ElMessage.error(`æ–‡ä»¶è¿‡å¤§: ${file.name}`)
      return false
    }
    
    return true
  })
  
  if (uploadedFiles.value.length + validFiles.length > 50) {
    ElMessage.error('æœ€å¤šåªèƒ½ä¸Šä¼ 50ä¸ªæ–‡ä»¶')
    return
  }
  
  uploadedFiles.value.push(...validFiles)
  ElMessage.success(`æˆåŠŸæ·»åŠ  ${validFiles.length} ä¸ªæ–‡ä»¶`)
}

// åˆ é™¤æ–‡ä»¶
const removeFile = (index: number) => {
  uploadedFiles.value.splice(index, 1)
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
const formatFileSize = (bytes: number) => {
  if (bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

// ä¸‹ä¸€æ­¥
const handleNext = () => {
  if (currentStep.value < 4) {
    currentStep.value++
    
    // å¦‚æœè¿›å…¥ç¬¬ä¸‰æ­¥ï¼Œå¼€å§‹YOLOè¯Šæ–­
    if (currentStep.value === 3) {
      startYOLODiagnosis()
    }
    
    // å¦‚æœè¿›å…¥ç¬¬å››æ­¥ï¼Œåˆå§‹åŒ–ç¡®è®¤è¯Šæ–­ç•Œé¢
    if (currentStep.value === 4) {
      initConfirmDiagnosis()
    }
  }
}

// å¼€å§‹AIè¯Šæ–­
const startAIDiagnosis = async () => {
  await startYOLODiagnosis()
}

// å¼€å§‹YOLOè¯Šæ–­
const startYOLODiagnosis = async () => {
  isAnalyzing.value = true
  analysisProgress.value = 0
  
  try {
    // æ¨¡æ‹ŸYOLOè¯Šæ–­è¿‡ç¨‹
    const interval = setInterval(() => {
      if (analysisProgress.value < 90) {
        analysisProgress.value += Math.random() * 10
      }
    }, 200)
    
    // æ¨¡æ‹Ÿè¯Šæ–­æ—¶é—´
    await new Promise(resolve => setTimeout(resolve, 3000))
    
    clearInterval(interval)
    analysisProgress.value = 100
    
    // æ¨¡æ‹Ÿè¯Šæ–­ç»“æœ
    diagnosisResult.value = {
      confidence: 0.87,
      findings: [
        {
          name: 'è…°æ¤é—´ç›˜çªå‡º (L4-L5)',
          confidence: 0.94,
          description: 'L4-L5æ¤é—´ç›˜åæ–¹çªå‡ºçº¦9.5mmï¼Œå‹è¿«ç¡¬è†œå›Šï¼Œç›¸åº”æ°´å¹³ç®¡æœ‰æ•ˆå®½åº¦å˜çª„ã€‚'
        },
        {
          name: 'æ¤ä½“éª¨è´¨å¢ç”Ÿ (L3-L5)',
          confidence: 0.87,
          description: 'L3-L5æ¤ä½“è¾¹ç¼˜è§éª¨è´¨å¢ç”Ÿï¼Œç¬¦åˆé€€è¡Œæ€§æ”¹å˜ï¼Œå¾…åˆå¹¶å…¶ä»–å½±åƒå­¦è¡¨ç°ã€‚'
        },
        {
          name: 'æ¤ç®¡ç‹­çª„ (L5-S1)',
          confidence: 0.82,
          description: 'L5-S1æ°´å¹³æ¤ç®¡æœ‰æ•ˆå®½åº¦çº¦9mmï¼Œæç¤ºæ¤ç®¡ç‹­çª„ã€‚'
        }
      ],
      recommendations: [
        'ç»“åˆæ‚£è€…ä¸´åºŠç—‡çŠ¶ï¼Œå¿…è¦æ—¶è¿›ä¸€æ­¥è¡ŒCTæˆ–å¢å¼ºMRIæ£€æŸ¥',
        'æ‚£è€…å¹´é¾„åŠå½±åƒå­¦è¡¨ç°ï¼Œå»ºè®®éª¨ç§‘ä¸´åºŠåŒ»ç”Ÿè¯„ä¼°æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ²»ç–—',
        'å»ºè®®å®šæœŸå¤æŸ¥ï¼Œç›‘æµ‹ç—…æƒ…å˜åŒ–'
      ]
    }
    
    // ç”ŸæˆAIå¤„ç†åçš„å›¾åƒï¼ˆåŒ…å«æ ‡æ³¨ï¼‰
    generateAIProcessedImages()
    
    ElMessage.success('AIè¯Šæ–­åˆ†æå®Œæˆ')
  } catch (error) {
    ElMessage.error('è¯Šæ–­åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    isAnalyzing.value = false
  }
}

// å®Œæˆè¯Šæ–­
const handleFinish = () => {
  ElMessage.success('è¯Šæ–­æµç¨‹å®Œæˆ')
  // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°è¯Šæ–­ç»“æœé¡µé¢æˆ–è¿”å›å·¥ä½œå°
  router.push('/dashboard/doctor')
}

// ç”ŸæˆAIå¤„ç†åçš„å›¾åƒ
const generateAIProcessedImages = () => {
  aiProcessedImages.value = uploadedFiles.value.map((file, index) => ({
    name: file.name,
    url: URL.createObjectURL(file),
    type: file.type,
    size: file.size,
    index: index,
    annotations: aiAnnotations.value // æ·»åŠ AIæ ‡æ³¨
  }))
}

// åˆå§‹åŒ–ç¡®è®¤è¯Šæ–­ç•Œé¢
const initConfirmDiagnosis = () => {
  // è®¾ç½®é»˜è®¤çš„AIå¤„ç†åçš„å›¾åƒ
  if (aiProcessedImages.value.length === 0) {
    generateAIProcessedImages()
  }
  
  // é‡ç½®ç•Œé¢çŠ¶æ€
  activeTab.value = 'diagnosis'
  activeTool.value = 'pan'
  currentImageIndex.value = 0
  
  // åˆå§‹åŒ–Canvas
  nextTick(() => {
    initCanvas()
  })
}

// åˆå§‹åŒ–Canvas
const initCanvas = () => {
  if (annotationCanvas.value && imageViewer.value) {
    canvas = annotationCanvas.value
    ctx = canvas.getContext('2d')
    
    if (ctx) {
      // è®¾ç½®Canvaså°ºå¯¸
      const rect = imageViewer.value.getBoundingClientRect()
      canvas.width = rect.width
      canvas.height = rect.height
      
      // è®¾ç½®Canvasæ ·å¼
      ctx.strokeStyle = currentColor.value
      ctx.lineWidth = currentLineWidth.value
      ctx.lineCap = 'round'
      ctx.lineJoin = 'round'
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      canvas.addEventListener('mousedown', handleMouseDown)
      canvas.addEventListener('mousemove', handleMouseMove)
      canvas.addEventListener('mouseup', handleMouseUp)
      canvas.addEventListener('wheel', handleWheel)
      
      console.log('Canvasåˆå§‹åŒ–æˆåŠŸ')
    }
  }
}

// ç¬¬å››æ­¥ç›¸å…³æ–¹æ³•
const setActiveTool = (tool: string) => {
  activeTool.value = tool
}

const setActiveTab = (tab: string) => {
  activeTab.value = tab
}

const selectImage = (index: number) => {
  currentImageIndex.value = index
}

const previousImage = () => {
  if (currentImageIndex.value > 0) {
    currentImageIndex.value--
  }
}

const nextImage = () => {
  if (currentImageIndex.value < aiProcessedImages.value.length - 1) {
    currentImageIndex.value++
  }
}

const updateWindowLevel = () => {
  // æ›´æ–°çª—ä½
}

const updateWindowWidth = () => {
  // æ›´æ–°çª—å®½
}

const setPresetWindow = (type: string) => {
  if (type === 'soft') {
    windowLevel.value = 40
    windowWidth.value = 400
  } else if (type === 'bone') {
    windowLevel.value = 300
    windowWidth.value = 1500
  }
}

const zoomIn = () => {
  zoomLevel.value = Math.min(zoomLevel.value * 1.2, 5)
}

const zoomOut = () => {
  zoomLevel.value = Math.max(zoomLevel.value / 1.2, 0.1)
}

const resetZoom = () => {
  zoomLevel.value = 1
  panX.value = 0
  panY.value = 0
}

const fitToWindow = () => {
  zoomLevel.value = 1
  panX.value = 0
  panY.value = 0
}

const handleSave = () => {
  ElMessage.success('è¯Šæ–­ç»“æœå·²ä¿å­˜')
}

const handleAIAnalysis = () => {
  ElMessage.info('é‡æ–°è¿›è¡ŒAIåˆ†æ')
  currentStep.value = 3
  diagnosisResult.value = null
  startAIDiagnosis()
}

const handleGenerateReport = () => {
  ElMessage.success('æ­£åœ¨è·³è½¬åˆ°æŠ¥å‘Šç”Ÿæˆé¡µé¢...')
  
  // å‡†å¤‡ä¼ é€’ç»™æŠ¥å‘Šé¡µé¢çš„æ•°æ®
  const reportData = {
    caseInfo: { ...formData },
    diagnosisResult: diagnosisResult.value,
    aiProcessedImages: aiProcessedImages.value,
    doctorReview: { ...doctorReview },
    finalDiagnosis: [...finalDiagnosis.value]
  }
  
  // è·³è½¬åˆ°æŠ¥å‘Šç”Ÿæˆé¡µé¢
  router.push({
    name: 'doctor.reportGeneration',
    state: reportData
  })
}

const addDiagnosis = () => {
  finalDiagnosis.value.push({
    name: '',
    confidence: '',
    description: ''
  })
}

const removeDiagnosis = (index: number) => {
  finalDiagnosis.value.splice(index, 1)
}

// è®¡ç®—å±æ€§
const currentImage = computed(() => {
  return aiProcessedImages.value[currentImageIndex.value] || null
})

const imageStyle = computed(() => {
  return {
    transform: `scale(${zoomLevel.value}) translate(${panX.value}px, ${panY.value}px)`,
    filter: `contrast(${windowWidth.value / 100}) brightness(${windowLevel.value / 100})`
  }
})

const getCursorStyle = () => {
  const cursorMap: Record<string, string> = {
    pan: 'grab',
    measure: 'crosshair',
    rectangle: 'crosshair',
    circle: 'crosshair',
    freehand: 'crosshair',
    text: 'text'
  }
  return cursorMap[activeTool.value] || 'default'
}

// é¼ æ ‡äº‹ä»¶å¤„ç†
const handleMouseDown = (e: MouseEvent) => {
  if (!canvas || !ctx) return
  
  const rect = canvas.getBoundingClientRect()
  startX = e.clientX - rect.left
  startY = e.clientY - rect.top
  
  if (activeTool.value === 'pan') {
    isPanning.value = true
    canvas.style.cursor = 'grabbing'
  } else if (activeTool.value === 'freehand') {
    isDrawing = true
    currentPath = [{ x: startX, y: startY }]
    ctx.beginPath()
    ctx.moveTo(startX, startY)
  } else if (activeTool.value === 'rectangle' || activeTool.value === 'circle') {
    isDrawing = true
  }
}

const handleMouseMove = (e: MouseEvent) => {
  if (!canvas || !ctx) return
  
  const rect = canvas.getBoundingClientRect()
  const currentX = e.clientX - rect.left
  const currentY = e.clientY - rect.top
  
  if (isPanning.value) {
    // å¹³ç§»å›¾åƒ
    panX.value += (currentX - startX) * 0.1
    panY.value += (currentY - startY) * 0.1
    startX = currentX
    startY = currentY
  } else if (isDrawing && activeTool.value === 'freehand') {
    // è‡ªç”±ç»˜åˆ¶
    currentPath.push({ x: currentX, y: currentY })
    ctx.lineTo(currentX, currentY)
    ctx.stroke()
  } else if (isDrawing && (activeTool.value === 'rectangle' || activeTool.value === 'circle')) {
    // ç»˜åˆ¶çŸ©å½¢æˆ–åœ†å½¢
    redrawCanvas()
    ctx.strokeStyle = currentColor.value
    ctx.lineWidth = currentLineWidth.value
    ctx.beginPath()
    
    if (activeTool.value === 'rectangle') {
      ctx.rect(startX, startY, currentX - startX, currentY - startY)
    } else if (activeTool.value === 'circle') {
      const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2))
      ctx.arc(startX, startY, radius, 0, 2 * Math.PI)
    }
    ctx.stroke()
  }
}

const handleMouseUp = (e: MouseEvent) => {
  if (!canvas || !ctx) return
  
  const rect = canvas.getBoundingClientRect()
  const endX = e.clientX - rect.left
  const endY = e.clientY - rect.top
  
  if (isPanning.value) {
    isPanning.value = false
    canvas.style.cursor = 'grab'
  } else if (isDrawing) {
    isDrawing = false
    
    if (activeTool.value === 'freehand' && currentPath.length > 1) {
      // ä¿å­˜è‡ªç”±ç»˜åˆ¶è·¯å¾„
      annotations.value.push({
        type: 'freehand',
        path: [...currentPath],
        color: currentColor.value,
        lineWidth: currentLineWidth.value
      })
    } else if (activeTool.value === 'rectangle') {
      // ä¿å­˜çŸ©å½¢æ ‡æ³¨
      annotations.value.push({
        type: 'rectangle',
        x: Math.min(startX, endX),
        y: Math.min(startY, endY),
        width: Math.abs(endX - startX),
        height: Math.abs(endY - startY),
        color: currentColor.value,
        lineWidth: currentLineWidth.value
      })
    } else if (activeTool.value === 'circle') {
      // ä¿å­˜åœ†å½¢æ ‡æ³¨
      const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2))
      annotations.value.push({
        type: 'circle',
        x: startX,
        y: startY,
        radius: radius,
        color: currentColor.value,
        lineWidth: currentLineWidth.value
      })
    }
    
    currentPath = []
  }
}

const handleWheel = (e: WheelEvent) => {
  e.preventDefault()
  const delta = e.deltaY > 0 ? 0.9 : 1.1
  zoomLevel.value = Math.max(0.1, Math.min(5, zoomLevel.value * delta))
}

// é‡ç»˜Canvas
const redrawCanvas = () => {
  if (!canvas || !ctx) return
  
  ctx.clearRect(0, 0, canvas.width, canvas.height)
  
  // é‡ç»˜æ‰€æœ‰æ ‡æ³¨
  annotations.value.forEach(annotation => {
    ctx.strokeStyle = annotation.color
    ctx.lineWidth = annotation.lineWidth
    ctx.beginPath()
    
    if (annotation.type === 'freehand') {
      if (annotation.path.length > 0) {
        ctx.moveTo(annotation.path[0].x, annotation.path[0].y)
        for (let i = 1; i < annotation.path.length; i++) {
          ctx.lineTo(annotation.path[i].x, annotation.path[i].y)
        }
        ctx.stroke()
      }
    } else if (annotation.type === 'rectangle') {
      ctx.rect(annotation.x, annotation.y, annotation.width, annotation.height)
      ctx.stroke()
    } else if (annotation.type === 'circle') {
      ctx.arc(annotation.x, annotation.y, annotation.radius, 0, 2 * Math.PI)
      ctx.stroke()
    }
  })
}

// æ¸…é™¤æ‰€æœ‰æ ‡æ³¨
const clearAnnotations = () => {
  annotations.value = []
  if (canvas && ctx) {
    ctx.clearRect(0, 0, canvas.width, canvas.height)
  }
}

// æ’¤é”€æœ€åä¸€ä¸ªæ ‡æ³¨
const undoLastAnnotation = () => {
  if (annotations.value.length > 0) {
    annotations.value.pop()
    redrawCanvas()
  }
}

// è¿›å…¥è¯Šæ–­ä¸­å¿ƒ
const goToDiagnosisCenter = () => {
  if (uploadedFiles.value.length === 0) {
    ElMessage.warning('è¯·å…ˆä¸Šä¼ å½±åƒæ–‡ä»¶æ‰èƒ½è¿›å…¥è¯Šæ–­ä¸­å¿ƒ')
    return
  }
  
  ElMessage.success('æ­£åœ¨è¿›å…¥è¯Šæ–­ä¸­å¿ƒ...')
  
  // åˆ›å»ºå½±åƒæ•°æ®ï¼Œä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸´æ—¶URL
  const imageData = uploadedFiles.value.map((file, index) => ({
    name: file.name,
    url: URL.createObjectURL(file),
    type: file.type,
    size: file.size,
    index: index
  }))
  
  console.log('å‡†å¤‡è·³è½¬åˆ°è¯Šæ–­ä¸­å¿ƒ')
  console.log('ä¸Šä¼ çš„æ–‡ä»¶æ•°é‡:', uploadedFiles.value.length)
  console.log('åˆ›å»ºçš„å½±åƒæ•°æ®:', imageData)
  console.log('ç—…ä¾‹ä¿¡æ¯:', formData)
  console.log('è¯Šæ–­ç»“æœ:', diagnosisResult.value)
  
  // é€šè¿‡è·¯ç”±çŠ¶æ€ä¼ é€’æ•°æ®
  router.push({
    name: 'doctor.imageCenter',
    state: {
      caseInfo: { ...formData },
      images: imageData,
      diagnosisResult: diagnosisResult.value
    }
  })
}

// å–æ¶ˆ
const handleCancel = () => {
  router.push('/dashboard/doctor')
}
</script>

<style scoped>
.image-diagnosis-page {
  min-height: 100vh;
  background: #f5f7fa;
}

/* é¡¶éƒ¨å¯¼èˆªæ  */
.header {
  background: white;
  border-bottom: 1px solid #e5e7eb;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
  font-weight: bold;
}

.header-title {
  font-size: 14px;
  color: #1f2937;
  font-weight: 600;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
}

.header-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #6b7280;
  font-size: 18px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: #f0f9ff;
  border-radius: 6px;
  cursor: pointer;
}

.user-name {
  font-size: 14px;
  color: #2563eb;
  font-weight: 600;
}

/* ä¸»å®¹å™¨ */
.container {
  max-width: 900px;
  margin: 40px auto;
  padding: 0 20px;
}

/* é¡µé¢æ ‡é¢˜ */
.page-header {
  margin-bottom: 30px;
}

.page-title {
  font-size: 28px;
  color: #1f2937;
  font-weight: 700;
  margin-bottom: 8px;
}

.page-subtitle {
  font-size: 14px;
  color: #6b7280;
}

/* æ­¥éª¤æŒ‡ç¤ºå™¨ */
.steps {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40px;
  position: relative;
}

.steps::before {
  content: '';
  position: absolute;
  top: 20px;
  left: 0;
  right: 0;
  height: 2px;
  background: #e5e7eb;
  z-index: 0;
}

.step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  position: relative;
  z-index: 1;
  flex: 1;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
  border: 2px solid #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #9ca3af;
  font-size: 16px;
}

.step.active .step-number {
  background: #2563eb;
  border-color: #2563eb;
  color: white;
}

.step-label {
  font-size: 12px;
  color: #6b7280;
  text-align: center;
}

.step.active .step-label {
  color: #2563eb;
  font-weight: 600;
}

/* è¡¨å•å¡ç‰‡ */
.form-card {
  background: white;
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.form-section-title {
  font-size: 16px;
  color: #1f2937;
  font-weight: 600;
  margin-bottom: 8px;
}

.form-section-subtitle {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 20px;
}

/* è¡¨å•è¡Œ */
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.form-row.full {
  grid-template-columns: 1fr;
}

/* è¡¨å•ç»„ */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-label {
  font-size: 14px;
  color: #1f2937;
  font-weight: 500;
}

.form-label .required {
  color: #ef4444;
}

.form-input,
.form-select,
.form-textarea {
  padding: 12px 14px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.3s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input::placeholder,
.form-select::placeholder {
  color: #9ca3af;
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

/* ä¸Šä¼ åŒºåŸŸ */
.upload-section {
  margin-bottom: 20px;
}

.upload-area {
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #fafbfc;
}

.upload-area:hover {
  border-color: #2563eb;
  background: #f0f9ff;
}

.upload-area.dragover {
  border-color: #2563eb;
  background: #f0f9ff;
}

.upload-icon {
  font-size: 48px;
  margin-bottom: 12px;
  color: #9ca3af;
}

.upload-title {
  font-size: 14px;
  color: #1f2937;
  font-weight: 600;
  margin-bottom: 4px;
}

.upload-subtitle {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 16px;
}

.upload-hint {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 16px;
}

.upload-btn {
  padding: 10px 24px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.upload-btn:hover {
  background: #1d4ed8;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

/* æ–‡ä»¶åˆ—è¡¨ */
.file-list {
  margin-top: 20px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
}

.file-list h4 {
  margin-bottom: 12px;
  color: #1f2937;
  font-size: 14px;
}

.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #e5e7eb;
}

.file-item:last-child {
  border-bottom: none;
}

.file-name {
  font-size: 14px;
  color: #1f2937;
  flex: 1;
}

.file-size {
  font-size: 12px;
  color: #6b7280;
  margin: 0 12px;
}

.remove-btn {
  padding: 4px 8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

/* å¸®åŠ©ä¿¡æ¯ */
.help-section {
  background: #f0f9ff;
  border-left: 4px solid #2563eb;
  padding: 16px;
  border-radius: 8px;
  margin-top: 20px;
}

.help-title {
  font-size: 14px;
  color: #2563eb;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.help-list {
  list-style: none;
  font-size: 12px;
  color: #6b7280;
  line-height: 1.8;
}

.help-list li {
  margin-bottom: 4px;
}

.help-list li::before {
  content: 'â€¢ ';
  color: #2563eb;
  font-weight: bold;
}

/* è¯Šæ–­ç»“æœ */
.analysis-progress {
  margin: 20px 0;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #2563eb, #1d4ed8);
  transition: width 0.3s ease;
}

.progress-text {
  text-align: center;
  font-size: 14px;
  color: #6b7280;
}

.diagnosis-result {
  margin-top: 20px;
}

.result-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 16px;
  background: #f0f9ff;
  border-radius: 8px;
}

.result-summary h3 {
  color: #1f2937;
  font-size: 18px;
}

.confidence-score {
  font-size: 16px;
  color: #2563eb;
  font-weight: 600;
}

.findings {
  margin-bottom: 20px;
}

.findings h4 {
  color: #1f2937;
  margin-bottom: 12px;
}

.finding-item {
  padding: 12px;
  background: #f9fafb;
  border-radius: 8px;
  margin-bottom: 8px;
}

.finding-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 4px;
}

.finding-confidence {
  font-size: 12px;
  color: #2563eb;
  margin-bottom: 4px;
}

.finding-description {
  font-size: 14px;
  color: #6b7280;
}

.recommendations h4 {
  color: #1f2937;
  margin-bottom: 12px;
}

.recommendations ul {
  list-style: none;
  padding-left: 0;
}

.recommendations li {
  padding: 8px 0;
  border-bottom: 1px solid #e5e7eb;
  color: #6b7280;
}

.recommendations li:last-child {
  border-bottom: none;
}

.recommendations li::before {
  content: 'â€¢ ';
  color: #2563eb;
  font-weight: bold;
}

/* æŒ‰é’®ç»„ */
.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 30px;
}

.btn {
  padding: 12px 32px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-cancel {
  background: white;
  color: #1f2937;
  border: 1px solid #e5e7eb;
}

.btn-cancel:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}

.btn-next {
  background: #2563eb;
  color: white;
  min-width: 120px;
}

.btn-next:hover:not(:disabled) {
  background: #1d4ed8;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-next::after {
  content: ' â†’';
}

.btn-center {
  background: #52c41a;
  color: white;
  min-width: 120px;
}

.btn-center:hover {
  background: #389e0d;
  box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
}

/* ç¬¬å››æ­¥ç¡®è®¤è¯Šæ–­æ ·å¼ */
.diagnosis-confirmation {
  position: fixed;
  top: 80px; /* å¯¼èˆªæ é«˜åº¦ */
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  background: #f8fafc;
  z-index: 1000;
  width: 100vw;
  height: calc(100vh - 80px);
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: white;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.top-bar-left {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}

.top-bar-center {
  display: flex;
  gap: 24px;
  font-size: 14px;
  color: #6b7280;
}

.top-bar-right {
  display: flex;
  gap: 12px;
}

.btn-save, .btn-ai, .btn-report {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-save {
  background: #f3f4f6;
  color: #374151;
}

.btn-save:hover {
  background: #e5e7eb;
}

.btn-ai {
  background: #3b82f6;
  color: white;
}

.btn-ai:hover {
  background: #2563eb;
}

.btn-report {
  background: #10b981;
  color: white;
}

.btn-report:hover {
  background: #059669;
}

.main-container {
  flex: 1;
  display: flex;
  height: calc(100vh - 140px); /* å‡å»é¡¶éƒ¨å¯¼èˆªæ å’Œé¡¶éƒ¨ä¿¡æ¯æ çš„é«˜åº¦ */
  overflow: hidden;
  min-height: 0;
}

.left-toolbar {
  width: 80px;
  background: #374151;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 0;
  gap: 8px;
  overflow-y: auto;
}

.toolbar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.toolbar-title {
  color: white;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 8px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
}

.toolbar-item {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #4b5563;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s;
}

.toolbar-item:hover {
  background: #6b7280;
}

.toolbar-item.active {
  background: #3b82f6;
}

.color-picker {
  display: flex;
  align-items: center;
  justify-content: center;
}

.color-input {
  width: 30px;
  height: 30px;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  background: none;
}

.color-input::-webkit-color-swatch-wrapper {
  padding: 0;
}

.color-input::-webkit-color-swatch {
  border: none;
  border-radius: 50%;
}

.middle-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
}

.image-controls {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
  gap: 16px;
}

.series-info {
  font-size: 14px;
  color: #374151;
  font-weight: 500;
}

.nav-buttons {
  display: flex;
  gap: 8px;
}

.nav-btn {
  padding: 6px 12px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.nav-btn:hover:not(:disabled) {
  background: #f3f4f6;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.image-input {
  display: flex;
  gap: 8px;
}

.image-input input {
  width: 80px;
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 12px;
}

.zoom-btn {
  padding: 6px 12px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.zoom-btn:hover {
  background: #f3f4f6;
}

.zoom-controls {
  display: flex;
  gap: 8px;
}

.image-viewer {
  flex: 1;
  position: relative;
  background: #000;
  overflow: hidden;
  min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
}

.image-container {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.medical-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: transform 0.2s;
}

.no-image-placeholder {
  color: white;
  text-align: center;
}

.annotation {
  position: absolute;
  border: 2px solid;
  border-radius: 4px;
  cursor: pointer;
}

.annotation.red {
  border-color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

.annotation.yellow {
  border-color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
}

.annotation-label {
  position: absolute;
  top: -24px;
  left: 0;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 12px;
  white-space: nowrap;
}

.annotation-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: auto;
}

.thumbnail-nav {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  overflow-x: auto;
}

.thumbnail {
  position: relative;
  width: 60px;
  height: 60px;
  border: 2px solid transparent;
  border-radius: 4px;
  cursor: pointer;
  flex-shrink: 0;
}

.thumbnail.active {
  border-color: #3b82f6;
}

.thumbnail-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 2px;
}

.thumbnail-number {
  position: absolute;
  bottom: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 1px 4px;
  border-radius: 2px;
  font-size: 10px;
}

.right-panel {
  width: 350px;
  background: white;
  border-left: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
  min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
}

.panel-tabs {
  display: flex;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.panel-tab {
  flex: 1;
  padding: 12px 16px;
  text-align: center;
  cursor: pointer;
  font-size: 14px;
  color: #6b7280;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.panel-tab:hover {
  color: #374151;
}

.panel-tab.active {
  color: #3b82f6;
  border-bottom-color: #3b82f6;
}

.panel-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 12px;
}

.result-item {
  margin-bottom: 16px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
}

.result-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.result-name {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
}

.result-confidence {
  font-size: 12px;
  color: #10b981;
  font-weight: 500;
}

.result-description {
  font-size: 13px;
  color: #6b7280;
  line-height: 1.4;
}

.finding-item {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 6px;
  padding-left: 12px;
  position: relative;
}

.finding-item::before {
  content: 'â€¢';
  position: absolute;
  left: 0;
  color: #9ca3af;
}

.ai-info {
  margin-top: 20px;
  padding: 12px;
  background: #eff6ff;
  border-radius: 6px;
}

.ai-info-title {
  font-size: 14px;
  font-weight: 600;
  color: #1e40af;
  margin-bottom: 8px;
}

.ai-info-item {
  font-size: 13px;
  color: #1e40af;
  margin-bottom: 4px;
}

.review-section {
  margin-bottom: 20px;
}

.review-section h4 {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.review-item {
  margin-bottom: 12px;
}

.review-item label {
  display: block;
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 4px;
}

.review-item select {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
}

.review-textarea {
  width: 100%;
  min-height: 80px;
  padding: 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
}

.final-diagnosis {
  margin-top: 12px;
}

.diagnosis-item {
  margin-bottom: 12px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
}

.diagnosis-input, .confidence-input {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  margin-bottom: 8px;
}

.description-textarea {
  width: 100%;
  min-height: 60px;
  padding: 6px 8px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 13px;
  resize: vertical;
  margin-bottom: 8px;
}

.remove-btn {
  padding: 4px 8px;
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

.remove-btn:hover {
  background: #dc2626;
}

.add-btn {
  width: 100%;
  padding: 8px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
}

.add-btn:hover {
  background: #2563eb;
}

.patient-info, .exam-info {
  margin-bottom: 16px;
}

.info-item {
  display: flex;
  margin-bottom: 8px;
}

.info-item .label {
  width: 80px;
  font-size: 13px;
  color: #6b7280;
}

.info-item .value {
  font-size: 13px;
  color: #374151;
}

.symptoms-info {
  font-size: 13px;
  color: #6b7280;
  line-height: 1.4;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
}

/* éªŒè¯æç¤ºä¿¡æ¯ */
.validation-hint {
  margin-top: 16px;
  padding: 12px;
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 8px;
  font-size: 12px;
}

.validation-hint p {
  margin-bottom: 8px;
  color: #0369a1;
  font-weight: 600;
}

.validation-hint ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.validation-hint li {
  margin-bottom: 4px;
  color: #0369a1;
}

.validation-hint span {
  display: block;
  padding: 2px 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }

  .steps {
    gap: 10px;
  }

  .step-label {
    font-size: 10px;
  }

  .form-card {
    padding: 20px;
  }

  .page-title {
    font-size: 20px;
  }

  .form-actions {
    flex-direction: column-reverse;
  }

  .btn {
    width: 100%;
  }
}
</style>
